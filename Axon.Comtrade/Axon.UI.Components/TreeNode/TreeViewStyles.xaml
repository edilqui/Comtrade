<!-- TreeViewStyles.xaml - Estructura corregida -->
<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:local="clr-namespace:Axon.UI.Components.TreeNode">

    <!-- Converters -->
    <local:LevelToIndentConverter x:Key="LevelToIndentConverter"/>
    <local:NodeTypeToColorConverter x:Key="NodeTypeToColorConverter"/>

    <!-- ESTILO PARA TreeViewItem -->
    <Style x:Key="SimpleTreeViewItemStyle" TargetType="TreeViewItem">
        <Setter Property="Background" Value="Transparent"/>
        <Setter Property="Foreground" Value="{StaticResource NeutralForeground1Brush}"/>
        <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
        <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="TreeViewItem">
                    <!-- Grid principal SIN altura fija -->
                    <Grid Background="Transparent">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <!-- Solo el header -->
                            <RowDefinition Height="*"/>
                            <!-- Los hijos -->
                        </Grid.RowDefinitions>

                        <!-- Header con altura fija y eventos de hover -->
                        <Grid x:Name="HoverArea" 
                              Grid.Row="0"
                              Height="32" 
                              Background="Transparent">

                            <!-- Eventos de hover solo para el header -->
                            <Grid.Triggers>
                                <EventTrigger RoutedEvent="Grid.MouseEnter">
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="AddButton"
                                                           Storyboard.TargetProperty="Opacity"
                                                           To="1"
                                                           Duration="0:0:0.2"/>
                                            <DoubleAnimation Storyboard.TargetName="MenuButton"
                                                           Storyboard.TargetProperty="Opacity"
                                                           To="1"
                                                           Duration="0:0:0.2"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </EventTrigger>

                                <EventTrigger RoutedEvent="Grid.MouseLeave">
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="AddButton"
                                                           Storyboard.TargetProperty="Opacity"
                                                           To="0"
                                                           Duration="0:0:0.2"/>
                                            <DoubleAnimation Storyboard.TargetName="MenuButton"
                                                           Storyboard.TargetProperty="Opacity"
                                                           To="0"
                                                           Duration="0:0:0.2"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </EventTrigger>
                            </Grid.Triggers>

                            <!-- Border que va de lado a lado -->
                            <Border x:Name="ItemBorder"
                                    Background="{TemplateBinding Background}"
                                    Padding="0"
                                    Margin="0"
                                    CornerRadius="{StaticResource BorderRadiusSmall}">

                                <!-- Contenido del header -->
                                <Grid>
                                    <!-- Contenido completo con indentación interna -->
                                    <StackPanel Orientation="Horizontal"
                                              VerticalAlignment="Center">

                                        <!-- Espaciado para indentación basado en Level -->
                                        <Rectangle Width="{Binding Level, Converter={StaticResource LevelToIndentConverter}}" 
                                                 Height="1" 
                                                 Fill="Transparent"/>

                                        <!-- Expander -->
                                        <ToggleButton x:Name="Expander"
                                                    IsChecked="{Binding Path=IsExpanded, RelativeSource={RelativeSource TemplatedParent}}"
                                                    Width="24"
                                                    Height="24"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Margin="0,0,4,0">
                                            <ToggleButton.Template>
                                                <ControlTemplate TargetType="ToggleButton">
                                                    <Border Background="Transparent">
                                                        <Viewbox Height="24" Width="24">
                                                            <Path x:Name="pathCollapse" Data="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" 
                          Fill="{StaticResource TextSecondaryBrush}" Width="24" Height="24"/>
                                                        </Viewbox>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsChecked" Value="True">
                                                            <Setter TargetName="pathCollapse" Property="Data" Value="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </ToggleButton.Template>
                                        </ToggleButton>

                                        <!-- Icono del tipo de nodo -->
                                        <Rectangle Width="16" Height="16" 
                                                 Fill="{Binding NodeType, Converter={StaticResource NodeTypeToColorConverter}}"
                                                 Margin="0,0,8,0"/>

                                        <!-- Texto del nodo -->
                                        <TextBlock Text="{Binding Title}"
                                                 Foreground="{StaticResource NeutralForeground1Brush}"
                                                 VerticalAlignment="Center"
                                                 FontSize="13"/>
                                    </StackPanel>

                                    <!-- Botones de acción alineados a la derecha -->
                                    <StackPanel Orientation="Horizontal"
                                              HorizontalAlignment="Right"
                                              VerticalAlignment="Center"
                                              Margin="8,0">

                                        <!-- Botón para agregar -->
                                        <Button x:Name="AddButton"
                                              Content="+"
                                              Background="{StaticResource NeutralBackground1Brush}"
                                              Foreground="{StaticResource NeutralForeground1Brush}"
                                              Width="24"
                                              Height="24"
                                              Margin="2,0"
                                              Command="{Binding AddChildCommand}"
                                              Opacity="0"
                                              BorderThickness="0">
                                            <Button.Template>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}"
                                                            CornerRadius="{StaticResource BorderRadiusSmall}">
                                                        <ContentPresenter HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="{StaticResource HoverBrush}"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Button.Template>
                                        </Button>

                                        <!-- Botón de menú -->
                                        <Button x:Name="MenuButton"
                                              Content="⋯"
                                              Background="{StaticResource NeutralBackground1Brush}"
                                              Foreground="{StaticResource NeutralForeground1Brush}"
                                              Width="24"
                                              Height="24"
                                              Margin="2,0"
                                              Opacity="0"
                                              BorderThickness="0">
                                            <Button.Template>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}"
                                                            CornerRadius="{StaticResource BorderRadiusSmall}">
                                                        <ContentPresenter HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="{StaticResource HoverBrush}"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Button.Template>
                                            <Button.ContextMenu>
                                                <ContextMenu>
                                                    <MenuItem Header="Agregar nodo" Command="{Binding AddChildCommand}"/>
                                                    <MenuItem Header="Eliminar" Command="{Binding DeleteCommand}"/>
                                                    <Separator/>
                                                    <MenuItem Header="Mover arriba" Command="{Binding MoveUpCommand}"/>
                                                    <MenuItem Header="Mover abajo" Command="{Binding MoveDownCommand}"/>
                                                </ContextMenu>
                                            </Button.ContextMenu>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </Grid>

                        <!-- Contenedor de hijos en la segunda fila -->
                        <ItemsPresenter x:Name="ItemsHost"
                                      Grid.Row="1"/>
                    </Grid>

                    <ControlTemplate.Triggers>
                        <!-- Ocultar expander si no hay hijos -->
                        <DataTrigger Binding="{Binding HasChildren}" Value="False">
                            <Setter TargetName="Expander" Property="Visibility" Value="Hidden"/>
                        </DataTrigger>

                        <!-- Controlar visibilidad de hijos -->
                        <Trigger Property="IsExpanded" Value="False">
                            <Setter TargetName="ItemsHost" Property="Visibility" Value="Collapsed"/>
                        </Trigger>

                        <!-- Efectos de hover en el área específica -->
                        <Trigger SourceName="HoverArea" Property="IsMouseOver" Value="True">
                            <Setter TargetName="ItemBorder" Property="Background" Value="{StaticResource HoverBrush}"/>
                        </Trigger>

                        <!-- Estado seleccionado -->
                        <Trigger Property="IsSelected" Value="True">
                            <Setter TargetName="ItemBorder" Property="Background" Value="{StaticResource NavigationItemBackgroundSelected}"/>
                            <Setter TargetName="AddButton" Property="Opacity" Value="1"/>
                            <Setter TargetName="MenuButton" Property="Opacity" Value="1"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- ESTILO PARA TreeView -->
    <Style x:Key="SimpleTreeViewStyle" TargetType="TreeView">
        <Setter Property="Background" Value="{StaticResource NeutralBackground1Brush}"/>
        <Setter Property="Foreground" Value="{StaticResource NeutralForeground1Brush}"/>
        <Setter Property="BorderBrush" Value="{StaticResource NeutralBackground1Brush}"/>
        <Setter Property="BorderThickness" Value="1"/>
        <Setter Property="ItemContainerStyle" Value="{StaticResource SimpleTreeViewItemStyle}"/>
        <!-- Asegurar que use el template jerárquico -->
        <Setter Property="ItemTemplate">
            <Setter.Value>
                <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                    <Grid/>
                </HierarchicalDataTemplate>
            </Setter.Value>
        </Setter>
    </Style>

</ResourceDictionary>