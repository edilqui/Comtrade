<UserControl x:Class="Axon.Comtrade.Views.DevicesListView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:customGrid ="clr-namespace:Axon.UI.Components.Datagrid;assembly=Axon.UI.Components"
             xmlns:local="clr-namespace:Axon.Comtrade.Views"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid Grid.Column="2" Background="{DynamicResource NeutralBackground2Brush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Panel de control -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="8" HorizontalAlignment="Right">
            <!--<Button Content="Agrupar por Grupo" 
                Command="{Binding GroupByGroupCommand}"
                Padding="8,4" Margin="4,0"/>
            <Button Content="Agrupar por Protocolo" 
                Command="{Binding GroupByProtocolCommand}"
                Padding="8,4" Margin="4,0"/>
            <Button Content="Sin Agrupación" 
                Command="{Binding ClearGroupingCommand}"
                Padding="8,4" Margin="4,0"/>-->
            <ToggleButton Content="Agrupación" 
                      IsChecked="{Binding ShowGrouping}"
                      Padding="8,4" Margin="4,0"/>
        </StackPanel>

        <Border Grid.Row="1"
            BorderBrush="#FF6B6B6B"
            Background="#FF2A2A2A"
            BorderThickness="1"
            CornerRadius="4">

            <customGrid:EnhancedCustomDataGrid x:Name="MainDataGrid" 
                                    Background="#FF1E1E1E"
                                    Foreground="White"
                                    BorderBrush="{DynamicResource ColorNeutralStrokeAccessibleBrush}"
                                    BorderThickness="1"
                                    GridLinesVisibility="Horizontal"
                                    HorizontalGridLinesBrush="#FF323232"
                                    ItemsSource="{Binding DataItems}"
                                    AutoGenerateColumns="False"
                                    CanUserAddRows="False"
                                    CanUserDeleteRows="False"
                                    AlternationCount="2"
                                    CanUserResizeColumns="True"
                                    CanUserReorderColumns="True"
                                    CanUserSortColumns="True">

                <!-- ✅ GroupStyle que SÍ funciona -->
                <DataGrid.GroupStyle>
                    <GroupStyle>
                        <GroupStyle.ContainerStyle>
                            <Style TargetType="{x:Type GroupItem}">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="{x:Type GroupItem}">
                                            <Expander x:Name="GroupExpander" IsExpanded="True">
                                                <Expander.Template>
                                                    <ControlTemplate TargetType="Expander">
                                                        <Grid>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="*"/>
                                                            </Grid.RowDefinitions>

                                                            <!-- Header clickeable -->
                                                            <Border x:Name="HeaderBorder" 
                                                                    Grid.Row="0"
                                                                    Background="{DynamicResource ColorNeutralBackground3Brush}"
                                                                    BorderBrush="DarkRed"
                                                                    BorderThickness="0,0,0,0"
                                                                    Padding="0,6"
                                                                    Cursor="Hand">
                                                                <Grid>
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="Auto"/>
                                                                        <ColumnDefinition Width="*"/>
                                                                    </Grid.ColumnDefinitions>

                                                                    <!-- Botón expandir/colapsar -->
                                                                    <ToggleButton x:Name="ExpanderToggle"
                                                                                  Grid.Column="0"
                                                                                  IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}}"
                                                                                  ClickMode="Press"
                                                                                  Background="Transparent"
                                                                                  BorderThickness="0"
                                                                                      Height="24"
                                                                                      Width="24"
                                                                                  Padding="4"
                                                                                  Margin="0,0,8,0">
                                                                        <ToggleButton.Template>
                                                                            <ControlTemplate TargetType="ToggleButton">
                                                                                <Border Background="Transparent">
                                                                                    <Viewbox Height="16" Width="16">
                                                                                        <Path x:Name="pathCollapse" 
                                                                  Data="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" 
                                                                  Fill="{StaticResource TextSecondaryBrush}" 
                                                                  Width="24" 
                                                                  Height="24"/>
                                                                                    </Viewbox>
                                                                                </Border>
                                                                                <ControlTemplate.Triggers>
                                                                                    <Trigger Property="IsChecked" Value="True">
                                                                                        <Setter TargetName="pathCollapse" Property="Data" Value="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                                                                                    </Trigger>
                                                                                </ControlTemplate.Triggers>
                                                                            </ControlTemplate>
                                                                        </ToggleButton.Template>
                                                                    </ToggleButton>

                                                                    <!-- Contenido del header -->
                                                                    <ContentPresenter Grid.Column="1" 
                                                                                      ContentSource="Header"
                                                                                      VerticalAlignment="Center"/>
                                                                </Grid>
                                                            </Border>

                                                            <!-- Contenido expandible -->
                                                            <Border x:Name="ContentBorder" 
                                                                    Grid.Row="1"
                                                                    Visibility="Visible">
                                                                <ContentPresenter x:Name="ContentPresenter"
                                                                                  Margin="-14,0,0,0"/>
                                                            </Border>
                                                        </Grid>

                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsExpanded" Value="False">
                                                                <Setter TargetName="ContentBorder" Property="Visibility" Value="Collapsed"/>
                                                            </Trigger>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter TargetName="HeaderBorder" Property="Background" Value="#FF4A4A4A"/>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Expander.Template>
                                                <Expander.Header>
                                                    <StackPanel Orientation="Horizontal" Height="30">
                                                        <!--<TextBlock Text="📁 " FontSize="14" VerticalAlignment="Center" Margin="5,0,5,0"/>-->
                                                        <TextBlock Text="{Binding Name}" 
                                                               FontWeight="Bold" 
                                                               FontSize="14"
                                                               Foreground="White"
                                                               VerticalAlignment="Center"/>
                                                        <TextBlock Text="{Binding ItemCount, StringFormat='  ({0} elementos)'}" 
                                                               FontSize="12"
                                                               Foreground="#FFCCCCCC"
                                                               VerticalAlignment="Center"
                                                               Margin="8,0"/>
                                                    </StackPanel>
                                                </Expander.Header>
                                                <Expander.Content>
                                                    <ItemsPresenter Margin="15,5"/>
                                                </Expander.Content>
                                            </Expander>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </GroupStyle.ContainerStyle>
                    </GroupStyle>
                </DataGrid.GroupStyle>

                <!-- Columnas -->
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Dispositivo" 
                                    Binding="{Binding DeviceName}"
                                    Width="200"/>
                    <DataGridTextColumn Header="IP" 
                                    Binding="{Binding IPAddress}"
                                    Width="150"/>
                    <DataGridTextColumn Header="Port" 
                                    Binding="{Binding Port}"
                                    Width="100"/>
                    <DataGridComboBoxColumn Header="Protocolo" 
                                        SelectedItemBinding="{Binding Protocol}"
                                        Width="120">
                        <DataGridComboBoxColumn.ItemsSource>
                            <x:Array Type="sys:String">
                                <sys:String>IEC-61850</sys:String>
                                <sys:String>FTP</sys:String>
                                <sys:String>TFTP</sys:String>
                                <sys:String>MODBUS</sys:String>
                            </x:Array>
                        </DataGridComboBoxColumn.ItemsSource>
                    </DataGridComboBoxColumn>
                </DataGrid.Columns>
            </customGrid:EnhancedCustomDataGrid>
        </Border>
    </Grid>
</UserControl>
