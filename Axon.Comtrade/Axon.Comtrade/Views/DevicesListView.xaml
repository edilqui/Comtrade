<UserControl x:Class="Axon.Comtrade.Views.DevicesListView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:customGrid ="clr-namespace:Axon.UI.Components.Datagrid;assembly=Axon.UI.Components"
             xmlns:local="clr-namespace:Axon.Comtrade.Views"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid Grid.Column="2" Background="{DynamicResource NeutralBackground2Brush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Panel de control -->
        <Border Grid.Row="0"
                BorderThickness="0,0,0,1"
                BorderBrush="{DynamicResource BorderBrush}"
                Height="{StaticResource SpacingVerticalXXXXXL}">
            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="8" HorizontalAlignment="Left">

                <Button Style="{StaticResource IconButtonStyle}" Padding="16,4" x:Name="buttonSlider">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="auto"/>
                            <ColumnDefinition/>
                        </Grid.ColumnDefinitions>
                        <Viewbox Height="24" Width="24">
                            <Path Data="M20 4H4A2 2 0 0 0 2 6V18A2 2 0 0 0 4 20H20A2 2 0 0 0 22 18V6A2 2 0 0 0 20 4M20 18H9V6H20Z" 
                          Fill="{DynamicResource TextSecondaryBrush}"
                          Width="24" Height="24"/>
                        </Viewbox>
                    </Grid>
                </Button>
                <Button Style="{StaticResource GhostButtonStyle}" Padding="16,4">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="auto"/>
                            <ColumnDefinition/>
                        </Grid.ColumnDefinitions>
                        <Viewbox Height="24" Width="24" Margin="0,0,4,0">
                            <Path Data="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" 
                          Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"
                          Width="24" Height="24"/>
                        </Viewbox>
                        <TextBlock Grid.Column="1" Text="Subestación" VerticalAlignment="Center"/>
                    </Grid>
                </Button>
            </StackPanel>
        </Border>

        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="{StaticResource MarginS}"  HorizontalAlignment="Left"
                    >

            <Button Style="{StaticResource PrimaryButtonStyle}" Padding="16,4">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="auto"/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>
                    <Viewbox Height="24" Width="24" Margin="0,0,4,0">
                        <Path Data="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" 
                          Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"
                          Width="24" Height="24"/>
                    </Viewbox>
                    <TextBlock Grid.Column="1" Text="Nuevo Dispositivo" VerticalAlignment="Center"/>
                </Grid>
            </Button>
            <Button Style="{StaticResource SecondaryButtonStyle}" Padding="16,4" Margin="{StaticResource MarginSHorizontal}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="auto"/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>
                    <Viewbox Height="24" Width="24" Margin="0,0,4,0">
                        <Path Data="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" 
                          Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"
                          Width="24" Height="24"/>
                    </Viewbox>
                    <TextBlock Grid.Column="1" Text="Importar Dispositivos" VerticalAlignment="Center"/>
                </Grid>
            </Button>
            <!--<Button Content="Secundary 123445656723453245"
                    Style="{DynamicResource SecondaryButtonStyle}"
                Command="{Binding GroupByGroupCommand}"
                Padding="8,4" Margin="4,0"/>

            <Button Content="Agrupar por Grupo"
                    Style="{DynamicResource OutlineButtonStyle}"
                Command="{Binding GroupByGroupCommand}"
                Padding="8,4" Margin="4,0"/>
            <Button Content="Agrupar por Protocolo" 
                    Style="{DynamicResource LargeButtonStyle}"
                Command="{Binding GroupByProtocolCommand}"
                Padding="8,4" Margin="4,0"/>
            <Button Content="Sin Agrupación" 
                    Style="{DynamicResource SmallButtonStyle}"
                Command="{Binding ClearGroupingCommand}"
                 Margin="4,0"/>
            <ToggleButton Content="Agrupación" 
                      IsChecked="{Binding ShowGrouping}"
                      Padding="8,4" Margin="4,0"/>-->
        </StackPanel>

        <Border Grid.Row="2"
             Margin="{StaticResource MarginS}"
            BorderBrush="#FF6B6B6B"
            Background="#FF2A2A2A"
            BorderThickness="0"
            CornerRadius="4">

            <customGrid:EnhancedCustomDataGrid x:Name="MainDataGrid" 
                                    Background="{DynamicResource TableBackground}"
                                    BorderBrush="{DynamicResource ColorNeutralStrokeAccessibleBrush}"
                                    BorderThickness="0"
                                    GridLinesVisibility="Horizontal"
                                    HorizontalGridLinesBrush="{DynamicResource TableBorder}"
                                    ItemsSource="{Binding DataItems}"
                                    AutoGenerateColumns="False"
                                    CanUserAddRows="False"
                                    CanUserDeleteRows="False"
                                    AlternationCount="1"
                                    CanUserResizeColumns="True"
                                    CanUserReorderColumns="True"
                                    CanUserSortColumns="True">

                <!-- ✅ GroupStyle que SÍ funciona -->
                <DataGrid.GroupStyle>
                    <GroupStyle>
                        <GroupStyle.ContainerStyle>
                            <Style TargetType="{x:Type GroupItem}">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="{x:Type GroupItem}">
                                            <Expander x:Name="GroupExpander" IsExpanded="True">
                                                <Expander.Template>
                                                    <ControlTemplate TargetType="Expander">
                                                        <Grid>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="*"/>
                                                            </Grid.RowDefinitions>

                                                            <!-- Header clickeable -->
                                                            <Border x:Name="HeaderBorder" 
                                                                    Grid.Row="0"
                                                                    Background="Transparent"
                                                                    BorderBrush="DarkRed"
                                                                    BorderThickness="0,0,0,0"
                                                                    Padding="0,6"
                                                                    Cursor="Hand">
                                                                <Grid>
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="Auto"/>
                                                                        <ColumnDefinition Width="*"/>
                                                                    </Grid.ColumnDefinitions>

                                                                    <!-- Botón expandir/colapsar -->
                                                                    <ToggleButton x:Name="ExpanderToggle"
                                                                                  Grid.Column="0"
                                                                                  IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}}"
                                                                                  ClickMode="Press"
                                                                                  Background="Transparent"
                                                                                  BorderThickness="0"
                                                                                      Height="24"
                                                                                      Width="24"
                                                                                  Padding="4"
                                                                                  Margin="0,0,8,0">
                                                                        <ToggleButton.Template>
                                                                            <ControlTemplate TargetType="ToggleButton">
                                                                                <Border Background="Transparent">
                                                                                    <Viewbox Height="16" Width="16">
                                                                                        <Path x:Name="pathCollapse" 
                                                                  Data="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" 
                                                                  Fill="{StaticResource TextSecondaryBrush}" 
                                                                  Width="24" 
                                                                  Height="24"/>
                                                                                    </Viewbox>
                                                                                </Border>
                                                                                <ControlTemplate.Triggers>
                                                                                    <Trigger Property="IsChecked" Value="True">
                                                                                        <Setter TargetName="pathCollapse" Property="Data" Value="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                                                                                    </Trigger>
                                                                                </ControlTemplate.Triggers>
                                                                            </ControlTemplate>
                                                                        </ToggleButton.Template>
                                                                    </ToggleButton>

                                                                    <!-- Contenido del header -->
                                                                    <ContentPresenter Grid.Column="1" 
                                                                                      ContentSource="Header"
                                                                                      VerticalAlignment="Center"/>
                                                                </Grid>
                                                            </Border>

                                                            <!-- Contenido expandible -->
                                                            <Border x:Name="ContentBorder" 
                                                                    Grid.Row="1"
                                                                    Visibility="Visible">
                                                                <ContentPresenter x:Name="ContentPresenter"
                                                                                  Margin="-14,0,0,0"/>
                                                            </Border>
                                                        </Grid>

                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsExpanded" Value="False">
                                                                <Setter TargetName="ContentBorder" Property="Visibility" Value="Collapsed"/>
                                                            </Trigger>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter TargetName="HeaderBorder" Property="Background" Value="{DynamicResource TableGroupHeaderBackgroundHover}"/>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Expander.Template>
                                                <Expander.Header>
                                                    <StackPanel Orientation="Horizontal" Height="30">
                                                        <!--<TextBlock Text="📁 " FontSize="14" VerticalAlignment="Center" Margin="5,0,5,0"/>-->
                                                        <TextBlock Text="{Binding Name}" 
                                                               FontWeight="SemiBold" 
                                                               FontSize="14"
                                                               Foreground="{DynamicResource TableHeaderForeground}"
                                                               VerticalAlignment="Center"/>
                                                        <TextBlock Text="{Binding ItemCount, StringFormat='  ({0} elementos)'}" 
                                                               FontSize="12"
                                                               Foreground="{DynamicResource TableHeaderForegroundHover}"
                                                               VerticalAlignment="Center"
                                                               Margin="8,0"/>
                                                    </StackPanel>
                                                </Expander.Header>
                                                <Expander.Content>
                                                    <ItemsPresenter Margin="15,5"/>
                                                </Expander.Content>
                                            </Expander>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </GroupStyle.ContainerStyle>
                    </GroupStyle>
                </DataGrid.GroupStyle>

                <!-- Columnas -->
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Dispositivo" 
                                    Binding="{Binding DeviceName}"
                                    Width="250"/>
                    <DataGridTextColumn Header="IP" 
                                    Binding="{Binding IPAddress}"
                                    Width="150"/>
                    <DataGridTextColumn Header="Port" 
                                    Binding="{Binding Port}"
                                    Width="100"/>
                    <DataGridTextColumn Header="Port" 
                                    Binding="{Binding Protocol}"
                                    Width="120"/>
                    <!-- Nueva columna de Acciones -->
                    <DataGridTemplateColumn Header="Acciones" Width="120" CanUserSort="False" CellStyle="{StaticResource ActionCellStyle}">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Stretch">
                                    <!--Botón Editar-->
                                    <Button 
                                        Style="{DynamicResource ColumnGridButtonStyle}"
                                        ToolTip="Editar dispositivo"
                                        Command="{Binding DataContext.EditDeviceCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding}"
                                        Margin="2,0">       

                                        <Viewbox Width="20" Height="20">
                                            <Path Data="M9 6V8H2V6H9M9 11V13H2V11H9M18 16V18H2V16H18M19.31 11.5C19.75 10.82 20 10 20 9.11C20 6.61 18 4.61 15.5 4.61S11 6.61 11 9.11 13 13.61 15.5 13.61C16.37 13.61 17.19 13.36 17.88 12.93L21 16L22.39 14.61L19.31 11.5M15.5 11.61C14.12 11.61 13 10.5 13 9.11S14.12 6.61 15.5 6.61 18 7.73 18 9.11 16.88 11.61 15.5 11.61Z" 
                                                  Fill="{DynamicResource PrimaryBrush}"
                                                  Height="24" Width="24"/>

                                        </Viewbox>
                                    </Button>

                                    <!--Botón Configurar-->
                                    <Button 
                                        Style="{DynamicResource ColumnGridButtonStyle}"
                                        ToolTip="Configurar dispositivo"
                                        Command="{Binding DataContext.ConfigureCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding}"
                                        Margin="2,0">       

                                        <Viewbox Width="20" Height="20">
                                            <Path Data="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M10,22C9.75,22 9.54,21.82 9.5,21.58L9.13,18.93C8.5,18.68 7.96,18.34 7.44,17.94L4.95,18.95C4.73,19.03 4.46,18.95 4.34,18.73L2.34,15.27C2.21,15.05 2.27,14.78 2.46,14.63L4.57,12.97L4.5,12L4.57,11L2.46,9.37C2.27,9.22 2.21,8.95 2.34,8.73L4.34,5.27C4.46,5.05 4.73,4.96 4.95,5.05L7.44,6.05C7.96,5.66 8.5,5.32 9.13,5.07L9.5,2.42C9.54,2.18 9.75,2 10,2H14C14.25,2 14.46,2.18 14.5,2.42L14.87,5.07C15.5,5.32 16.04,5.66 16.56,6.05L19.05,5.05C19.27,4.96 19.54,5.05 19.66,5.27L21.66,8.73C21.79,8.95 21.73,9.22 21.54,9.37L19.43,11L19.5,12L19.43,13L21.54,14.63C21.73,14.78 21.79,15.05 21.66,15.27L19.66,18.73C19.54,18.95 19.27,19.04 19.05,18.95L16.56,17.95C16.04,18.34 15.5,18.68 14.87,18.93L14.5,21.58C14.46,21.82 14.25,22 14,22H10M11.25,4L10.88,6.61C9.68,6.86 8.62,7.5 7.85,8.39L5.44,7.35L4.69,8.65L6.8,10.2C6.4,11.37 6.4,12.64 6.8,13.8L4.68,15.36L5.43,16.66L7.86,15.62C8.63,16.5 9.68,17.14 10.87,17.38L11.24,20H12.76L13.13,17.39C14.32,17.14 15.37,16.5 16.14,15.62L18.57,16.66L19.32,15.36L17.2,13.81C17.6,12.64 17.6,11.37 17.2,10.2L19.31,8.65L18.56,7.35L16.15,8.39C15.38,7.5 14.32,6.86 13.12,6.62L12.75,4H11.25Z" 
                                                  Fill="{DynamicResource TextTertiaryBrush}"
                                                  Height="24" Width="24"/>
                                        </Viewbox>
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </customGrid:EnhancedCustomDataGrid>
        </Border>
    </Grid>
</UserControl>
