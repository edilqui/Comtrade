<Window x:Class="Axon.Comtrade.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:nav="clr-namespace:Axon.UI.Components.Navigation;assembly=Axon.UI.Components"
        xmlns:tree="clr-namespace:Axon.UI.Components.TreeNode;assembly=Axon.UI.Components"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
    xmlns:local="clr-namespace:Axon.Comtrade" 
        xmlns:buttons="clr-namespace:Axon.UI.Components.Buttons;assembly=Axon.UI.Components"
        xmlns:customGrid ="clr-namespace:Axon.UI.Components.Datagrid;assembly=Axon.UI.Components"
        xmlns:gridOld ="clr-namespace:Axon.Wpf.Common;assembly=Axon.Wpf.Common"
        xmlns:views="clr-namespace:Axon.Comtrade.Views"
        mc:Ignorable="d"
        Title="MainWindow" Height="450" Width="800">
    <Window.Resources>
        <!-- Importar los estilos del TreeView y DataGrid -->
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/Axon.UI.Components;component/TreeNode/TreeViewStyles.xaml"/>
                <!-- ✅ AGREGAR: Importar estilos de agrupación -->
                <ResourceDictionary Source="pack://application:,,,/Axon.UI.Components;component/Datagrid/DataGridGroupingStyles.xaml"/>
                <ResourceDictionary Source="pack://application:,,,/Axon.UI.Components;component/Datagrid/EnhancedDataGridStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <!-- ✅ SOLUCIÓN AGRESIVA: Override global del ToggleButton en Expanders -->
            <Style TargetType="{x:Type ToggleButton}" x:Key="CustomExpanderToggleStyle">
                <Setter Property="Focusable" Value="False"/>
                <Setter Property="Width" Value="16"/>
                <Setter Property="Height" Value="16"/>
                <Setter Property="Margin" Value="4"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type ToggleButton}">
                            <Border x:Name="ExpanderButtonBorder"
                                    Background="#FF575757"
                                    BorderBrush="#FF8A8A8A"
                                    BorderThickness="1"
                                    CornerRadius="2"
                                    Width="16"
                                    Height="16">
                                <Path x:Name="ExpanderArrow"
                                      Fill="White"
                                      HorizontalAlignment="Center"
                                      VerticalAlignment="Center"
                                      Data="M 0 0 L 0 6 L 4 3 z"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsChecked" Value="True">
                                    <Setter TargetName="ExpanderArrow" Property="Data" Value="M 0 0 L 6 0 L 3 3 z"/>
                                </Trigger>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="ExpanderButtonBorder" Property="Background" Value="#FF6B6B6B"/>
                                    <Setter TargetName="ExpanderButtonBorder" Property="BorderBrush" Value="#FF9A9A9A"/>
                                </Trigger>
                                <Trigger Property="IsPressed" Value="True">
                                    <Setter TargetName="ExpanderButtonBorder" Property="Background" Value="#FF0078D4"/>
                                    <Setter TargetName="ExpanderButtonBorder" Property="BorderBrush" Value="#FF005A9E"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>
        </ResourceDictionary>
    </Window.Resources>
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="auto"/>
            <ColumnDefinition Width="300"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- SIDEBAR NAVIGATION -->
        <nav:SidebarNavigation x:Name="MainNavigation" Background="Red"
                              Grid.Column="0"
                              Title=""
                              SelectedItem="devices"
                              ItemSelected="MainNavigation_ItemSelected">

            <nav:NavigationItem Id="devices" Text="Dispositivos" IsSelected="True" Tooltip ="Dispositivos" >
                <nav:NavigationItem.Icon>
                    <Viewbox Height="24" Width="24">
                        <Path Data="M20,18H4V8H20M20,6H12L10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6Z" 
                          Fill="{StaticResource TextSecondaryBrush}" Width="24" Height="24"/>
                    </Viewbox>
                </nav:NavigationItem.Icon>
                <nav:NavigationItem.HomeFilledIcon>
                    <Viewbox Height="24" Width="24">
                        <Path Data="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z" 
                          Fill="{StaticResource BrandForeground1Brush}" Width="24" Height="24"/>
                    </Viewbox>
                </nav:NavigationItem.HomeFilledIcon>
            </nav:NavigationItem>
            <nav:NavigationItem Id="archivado" Text="Archivado" IsSelected="False">
                <nav:NavigationItem.Icon>
                    <Viewbox Height="24" Width="24">
                        <Path Data="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" 
                          Fill="{StaticResource TextSecondaryBrush}" Width="24" Height="24"/>
                    </Viewbox>
                </nav:NavigationItem.Icon>
                <nav:NavigationItem.HomeFilledIcon>
                    <Viewbox Height="24" Width="24">
                        <Path Data="M13,9V3.5L18.5,9M6,2C4.89,2 4,2.89 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6Z" 
                          Fill="{StaticResource BrandForeground1Brush}" Width="24" Height="24"/>
                    </Viewbox>
                </nav:NavigationItem.HomeFilledIcon>
            </nav:NavigationItem>
            <nav:NavigationItem Id="renombrado" Text="Renombrado" IsSelected="False">
                <nav:NavigationItem.Icon>
                    <Viewbox Height="24" Width="24">
                        <Path Data="M17,7H22V17H17V19A1,1 0 0,0 18,20H20V22H17.5C16.95,22 16,21.55 16,21C16,21.55 15.05,22 14.5,22H12V20H14A1,1 0 0,0 15,19V5A1,1 0 0,0 14,4H12V2H14.5C15.05,2 16,2.45 16,3C16,2.45 16.95,2 17.5,2H20V4H18A1,1 0 0,0 17,5V7M2,7H13V9H4V15H13V17H2V7M20,15V9H17V15H20Z" 
                          Fill="{StaticResource TextSecondaryBrush}" Width="24" Height="24"/>
                    </Viewbox>
                </nav:NavigationItem.Icon>
                <nav:NavigationItem.HomeFilledIcon>
                    <Viewbox Height="24" Width="24">
                        <Path Data="M17,7H22V17H17V19A1,1 0 0,0 18,20H20V22H17.5C16.95,22 16,21.55 16,21C16,21.55 15.05,22 14.5,22H12V20H14A1,1 0 0,0 15,19V5A1,1 0 0,0 14,4H12V2H14.5C15.05,2 16,2.45 16,3C16,2.45 16.95,2 17.5,2H20V4H18A1,1 0 0,0 17,5V7M2,7H13V9H4V15H13V17H2V7M20,15V9H17V15H20Z" 
                          Fill="{StaticResource BrandForeground1Brush}" Width="24" Height="24"/>
                    </Viewbox>
                </nav:NavigationItem.HomeFilledIcon>
            </nav:NavigationItem>
            <nav:NavigationItem Id="analisis" Text="Análisis de falla" IsSelected="False">
                <nav:NavigationItem.Icon>
                    <Viewbox Height="24" Width="24">
                        <Path Data="M5,2H15L11.5,9H15L8,22V14H5V2M7,4V12H10V14.66L12,11H8.24L11.76,4M17,15H19V17H17V15M17,7H19V13H17V7Z" 
                          Fill="{StaticResource TextSecondaryBrush}" Width="24" Height="24"/>
                    </Viewbox>
                </nav:NavigationItem.Icon>
                <nav:NavigationItem.HomeFilledIcon>
                    <Viewbox Height="24" Width="24">
                        <Path Data="M5,2V13H8V22L15,10H11L15,2M17,15H19V17H17V15M17,7H19V13H17V7Z" 
                          Fill="{StaticResource BrandForeground1Brush}" Width="24" Height="24"/>
                    </Viewbox>
                </nav:NavigationItem.HomeFilledIcon>
            </nav:NavigationItem>
            <nav:NavigationSeparator/>
            <nav:NavigationItem Id="Configuracion" Text="Configuracion" IsSelected="False">
                <nav:NavigationItem.Icon>
                    <Viewbox Height="24" Width="24">
                        <Path Data="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" 
                          Fill="{StaticResource TextSecondaryBrush}" Width="24" Height="24"/>
                    </Viewbox>
                </nav:NavigationItem.Icon>
                <nav:NavigationItem.HomeFilledIcon>
                    <Viewbox Height="24" Width="24">
                        <Path Data="M13,9V3.5L18.5,9M6,2C4.89,2 4,2.89 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6Z" 
                          Fill="{StaticResource BrandForeground1Brush}" Width="24" Height="24"/>
                    </Viewbox>
                </nav:NavigationItem.HomeFilledIcon>
            </nav:NavigationItem>

        </nav:SidebarNavigation>

        <!--ARBOL DE TOPOLOGIAS-->
        <views:TopologyPanel DataContext="{Binding Tree}" Grid.Column="1"></views:TopologyPanel>

        <Border
            DataContext="{Binding GridExample}"
            Grid.Column="2"
                BorderBrush="{StaticResource NeutralForegroundDisabledBrush}"
                Background="{DynamicResource NeutralBackground4Brush}"
                BorderThickness="1"
                CornerRadius="4">

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- ✅ NUEVO: Panel de control -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="8" HorizontalAlignment="Right">
                    <Button Content="Agrupar por Grupo" 
                            Command="{Binding GroupByGroupCommand}"
                            Padding="8,4"
                            Margin="4,0"
                            Background="{StaticResource NeutralBackground2Brush}"
                            Foreground="{StaticResource NeutralForeground1Brush}"
                            BorderBrush="{StaticResource NeutralStroke1Brush}"/>
                    <Button Content="Agrupar por Protocolo" 
                            Command="{Binding GroupByProtocolCommand}"
                            Padding="8,4"
                            Margin="4,0"
                            Background="{StaticResource NeutralBackground2Brush}"
                            Foreground="{StaticResource NeutralForeground1Brush}"
                            BorderBrush="{StaticResource NeutralStroke1Brush}"/>
                    <Button Content="Sin Agrupación" 
                            Command="{Binding ClearGroupingCommand}"
                            Padding="8,4"
                            Margin="4,0"
                            Background="{StaticResource NeutralBackground2Brush}"
                            Foreground="{StaticResource NeutralForeground1Brush}"
                            BorderBrush="{StaticResource NeutralStroke1Brush}"/>
                    <ToggleButton Content="Filtros" 
                                  IsChecked="{Binding ShowFilters}"
                                  Padding="8,4"
                                  Margin="4,0"/>
                    <ToggleButton Content="Agrupación" 
                                  IsChecked="{Binding ShowGrouping}"
                                  Padding="8,4"
                                  Margin="4,0"/>
                </StackPanel>

                <!-- ✅ CAMBIO: Configurar correctamente el DataGrid con agrupación -->
                <customGrid:EnhancedCustomDataGrid x:Name="MainDataGrid" 
                                                   CellStyle="{StaticResource EnhancedDataGridCellStyle}"
                                            RowStyle="{StaticResource EnhancedDataGridRowStyle}"
                                            Grid.Row="1"
                                            Background="Transparent"
                                            Foreground="{StaticResource NeutralForeground1Brush}"
                                            ShowGrouping="True"
                                            ItemsSource="{Binding DataItems}"
                                            AlternationCount="2"
                                            CanUserResizeColumns="True"
                                            CanUserReorderColumns="True"
                                            CanUserSortColumns="True">

                    <!-- ✅ SOLUCIÓN: GroupStyle corregido y funcional -->
                    <DataGrid.GroupStyle>
                        <GroupStyle>
                            <GroupStyle.Panel>
                                <ItemsPanelTemplate>
                                    <DataGridRowsPresenter/>
                                </ItemsPanelTemplate>
                            </GroupStyle.Panel>
                            <GroupStyle.ContainerStyle>
                                <Style TargetType="{x:Type GroupItem}">
                                    <Setter Property="Foreground"
                                        Value="{Binding Foreground, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                                    <Setter Property="Margin" Value="0,0,0,2"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="{x:Type GroupItem}">
                                                <Expander x:Name="GroupExpander" IsExpanded="True">
                                                    <Expander.Template>
                                                        <ControlTemplate TargetType="Expander">
                                                            <Grid>
                                                                <Grid.RowDefinitions>
                                                                    <RowDefinition Height="Auto"/>
                                                                    <RowDefinition Height="*"/>
                                                                </Grid.RowDefinitions>

                                                                <!-- Header clickeable -->
                                                                <Border x:Name="HeaderBorder" 
                                                                    Grid.Row="0"
                                                                    Background="#FF3F3F46"
                                                                    BorderBrush="#FF6B6B6B"
                                                                    BorderThickness="0,0,0,1"
                                                                    Padding="8,6"
                                                                    Cursor="Hand">
                                                                    <Grid>
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="Auto"/>
                                                                            <ColumnDefinition Width="*"/>
                                                                        </Grid.ColumnDefinitions>

                                                                        <!-- Botón expandir/colapsar -->
                                                                        <ToggleButton x:Name="ExpanderToggle"
                                                                                  Grid.Column="0"
                                                                                  IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}}"
                                                                                  ClickMode="Press"
                                                                                  Background="Transparent"
                                                                                  BorderThickness="0"
                                                                                      Height="24"
                                                                                      Width="24"
                                                                                  Padding="4"
                                                                                  Margin="0,0,8,0">
                                                                            <ToggleButton.Template>
                                                                                <ControlTemplate TargetType="ToggleButton">
                                                                                    <Border Background="Transparent">
                                                                                        <Viewbox Height="16" Width="16">
                                                                                            <Path x:Name="pathCollapse" 
                                                                  Data="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" 
                                                                  Fill="{StaticResource TextSecondaryBrush}" 
                                                                  Width="24" 
                                                                  Height="24"/>
                                                                                        </Viewbox>
                                                                                    </Border>
                                                                                    <ControlTemplate.Triggers>
                                                                                        <Trigger Property="IsChecked" Value="True">
                                                                                            <Setter TargetName="pathCollapse" Property="Data" Value="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                                                                                        </Trigger>
                                                                                    </ControlTemplate.Triggers>
                                                                                </ControlTemplate>
                                                                            </ToggleButton.Template>
                                                                        </ToggleButton>

                                                                        <!-- Contenido del header -->
                                                                        <ContentPresenter Grid.Column="1" 
                                                                                      ContentSource="Header"
                                                                                      VerticalAlignment="Center"/>
                                                                    </Grid>
                                                                </Border>

                                                                <!-- Contenido expandible -->
                                                                <Border x:Name="ContentBorder" 
                                                                    Grid.Row="1"
                                                                    Visibility="Visible">
                                                                    <ContentPresenter x:Name="ContentPresenter"
                                                                                  Margin="20,0,0,0"/>
                                                                </Border>
                                                            </Grid>

                                                            <ControlTemplate.Triggers>
                                                                <Trigger Property="IsExpanded" Value="False">
                                                                    <Setter TargetName="ContentBorder" Property="Visibility" Value="Collapsed"/>
                                                                </Trigger>
                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                    <Setter TargetName="HeaderBorder" Property="Background" Value="#FF4A4A4A"/>
                                                                </Trigger>
                                                            </ControlTemplate.Triggers>
                                                        </ControlTemplate>
                                                    </Expander.Template>

                                                    <Expander.Header>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding Name}" 
                                                                   FontWeight="SemiBold"
                                                                   FontSize="14"
                                                                   Foreground="#FFEEEEEE"
                                                                   VerticalAlignment="Center"/>
                                                            <TextBlock Text="{Binding ItemCount, StringFormat='  ({0} elementos)'}" 
                                                                   FontSize="12"
                                                                   Foreground="#FFBBBBBB"
                                                                   VerticalAlignment="Center"/>
                                                        </StackPanel>
                                                    </Expander.Header>

                                                    <Expander.Content>
                                                        <ItemsPresenter
                TextElement.Foreground="{Binding Foreground,
                  RelativeSource={RelativeSource AncestorType=Expander}}"/>
                                                    </Expander.Content>
                                                </Expander>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </GroupStyle.ContainerStyle>
                        </GroupStyle>
                    </DataGrid.GroupStyle>

                    <!-- Definir columnas -->
                    <DataGrid.Columns>
                        <!-- Columna de texto -->
                        <DataGridTextColumn Header="Dispositivo" 
                                      Binding="{Binding DeviceName}"
                                      Width="200"/>

                        <!-- Columna de IP -->
                        <DataGridTextColumn Header="IP" 
                                      Binding="{Binding IPAddress}"
                                      Width="150"/>

                        <!-- Columna de Puerto -->
                        <DataGridTextColumn Header="Port" 
                                      Binding="{Binding Port}"
                                      Width="100"/>

                        <DataGridComboBoxColumn Header="Protocolo" 
                                          SelectedItemBinding="{Binding Protocol}"
                                          Width="120">
                            <DataGridComboBoxColumn.ItemsSource>
                                <x:Array Type="sys:String">
                                    <sys:String>IEC-61850</sys:String>
                                    <sys:String>FTP</sys:String>
                                    <sys:String>TFTP</sys:String>
                                    <sys:String>MODBUS</sys:String>
                                </x:Array>
                            </DataGridComboBoxColumn.ItemsSource>
                        </DataGridComboBoxColumn>
                    </DataGrid.Columns>
                </customGrid:EnhancedCustomDataGrid>
            </Grid>
        </Border>
    </Grid>
</Window>